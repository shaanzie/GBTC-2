<!DOCTYPE html>
<html>
<title>Voting Main Page</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="all.css">
<script type="text/javascript" src="voting.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-firestore.js"></script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyBJg4TC1_XWaPRPYodprTUBYk3SFU1b2OQ",
    authDomain: "gbtc-2239b.firebaseapp.com",
    databaseURL: "https://gbtc-2239b.firebaseio.com",
    projectId: "gbtc-2239b",
    storageBucket: "",
    messagingSenderId: "1051924858252",
    appId: "1:1051924858252:web:84ec78e99bf7fa58"
  };
    firebase.initializeApp(firebaseConfig);


  
  
  function fun(){
    var name = window.sessionStorage.getItem("Name");
    var constID = window.sessionStorage.getItem("ConstID");
    if(name == null)
    {
      window.location.href = "index.html";
    }
    var h2 = document.getElementById("name");
    h2.textContent = "Hello " + name + "!";
    var db = firebase.firestore();
    db.collection("CandidateList").where('Constituency ID', '==', parseInt(constID)).get().then((querySnapshot) => {
    var counter = 0;
    var main_list = document.getElementById('main_list');
    querySnapshot.forEach((doc) => {
        
        var listElement = document.getElementById('list');
        var cloneList = listElement.cloneNode(true);
        var spanCloneName = cloneList.querySelector('#name');
        var spanCloneConst = cloneList.querySelector('#const');
        var imgTag = cloneList.querySelector('#photo');
        imgTag.setAttribute('src', doc.data()['Party'])
        spanCloneName.textContent = String(doc.data()['Name']);
        spanCloneConst.textContent = String(doc.data()['Constituency Name']);
        cloneList.setAttribute('id',counter++);
        cloneList.setAttribute('style','display: block');
        main_list.appendChild(cloneList);
    });

});

}
</script>
<body onload="fun()">
<div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
    <div class="w3-container" >
        <h2 id= "name"></h2>
        <h2>Candidates List</h2>
        <ul id="main_list" class="w3-ul w3-card-4">
        <li class='w3-bar' id = "list" style="display: none">
                <img src="dummy.jpg" id='photo' class ='w3-bar-item w3-circle w3-hide-small' style='width:85px'>
                <div class='w3-bar-item'>
                    <span class='w3-large'id = 'name'>John Doe</span><br>
                    <span id = 'const'>Fake Constituency</span><br><br>
                    <button class = "w3-animate-top w3-button" id="vote" onclick="vote(event)">Vote</button>
                </div>
        </li>
    </ul>
    </div>
</div>
<script>
  //sends vote to azure
  function vote(e){
    var target=e.target;
    var parent=target.parentNode;
    var cid= parent.querySelector("#name").textContent+parent.querySelector("#const").textContent;
    var cidjson={candidateid:cid};
    console.log(cidjson);
    $.ajax({
      type: 'POST',
      url: "http://localhost:5000/api/v1/create",
      data: JSON.stringify(cidjson),
      dataType: 'json',
      contentType: 'application/json',
      success: function(data) {
        console.log(data);
        //call trace here
        traceaction();
      }
    });
  }
function traceaction(){
  $.ajax({
      type: 'GET',
      url: "http://localhost:5000/api/v1/action",
      success: function(data) {
        console.log(data);
        //call verify here
        var val=verify();
        if (val){
          //message box of success, reset all session variables, restart back to home.
          console.log("success");
        }
        else{
          //messages box of failure, reset all session variables, send emails
          //email(); optiponal?
          console.log("failed");
        }
      }
    }); 
}

function verify(){
  $.ajax({
      type: 'GET',
      url: "http://localhost:5000/api/v1/verify",
      success: function(data) {
        console.log(data);
        return True;
      },
    error: function(){
      return false;
    }
    }); 
}
</script>
</body>
</html>


